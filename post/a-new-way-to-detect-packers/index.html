<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> A New Way to Detect Packers &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Feb 15, 2012</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          â€¢ 900 words 4 min. read
        </div>
        <h1>A New Way to Detect Packers</h1>
        <section id="post-content" class="article-content post">
          <div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">Reverse engineering executables is always a very challenging procedure especially if the analyzed executable has been packed or encrypted. &nbsp;I've been talking a lot about packers and unpackers (take a look to these posts&nbsp;<a href="http://marcoramilli.blogspot.com/search?q=packer&amp;x=0&amp;y=0">here</a>) but the technique I am going to show you is totally new respect to those already described. &nbsp;As you might know the most difficult procedure of reversing a packed (or encrypted) executable is to find out the original entry point (OE). Again, there are tons of ways to figure out if an executable is packed or not (aka PEiD) but there is no a universal known way to unpack it. The following image shows <a href="http://peid.has.it/">PEiD</a>&nbsp;in action.</div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-q3ucDPTSTac/Tzt5qvhLLaI/AAAAAAAAK6I/F5r2Haaujdo/s1600/Screen+Shot+2012-02-15+at+10.23.35+AM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="185" src="http://4.bp.blogspot.com/-q3ucDPTSTac/Tzt5qvhLLaI/AAAAAAAAK6I/F5r2Haaujdo/s320/Screen+Shot+2012-02-15+at+10.23.35+AM.png" width="320" /></a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">PEID finds out that the executable has been packed with Aspack v2.12.&nbsp;Nowadays you might find specific unpackers (unpackers designed for a specific packing procedure) &nbsp;but there is no way to have an ultimate universal unpacker. <a href="http://www.exetools.com/unpackers.htm">Here</a> you can find many of those packers. YES, I know, there are universal unpackers too, but those unpackers are signature based, meaning that they are not able to unpack "new" packing procedure (algorithms), they must include the signature of every used algorithms. The following pictures shows one of my favorite Unpackers: Faster Universal Unpacker from <a href="http://www.openrce.org/articles/">RCE</a>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-yqMPYzEnJeU/Tzt6t-zzSgI/AAAAAAAAK6Q/zBo9yZh_eVs/s1600/Screen+Shot+2012-02-15+at+10.27.16+AM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="288" src="http://1.bp.blogspot.com/-yqMPYzEnJeU/Tzt6t-zzSgI/AAAAAAAAK6Q/zBo9yZh_eVs/s320/Screen+Shot+2012-02-15+at+10.27.16+AM.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: justify;">A group of the New Mexico Tech designed a visualization tool based on Entropy (system calls, oriented graphs and so on) called <a href="http://csr.lanl.gov/vera/">VERA</a> (read more <a href="http://www.offensivecomputing.net/vizsec09/dquist-vizsec09.pdf">here</a>, <a href="http://www.offensivecomputing.net/bhusa2009/oc-reversing-by-crayon-bhusa2009.pdf">here</a>&nbsp;and <a href="http://csr.lanl.gov/vera/">here</a>). &nbsp;By using this tool you are able to distinguish between packers / encryptors STUB and unpacked / decrypted code by simply analyzing the execution of the executable. The following image shows the notepad.exe (yes the one in WinXP) traced by <a href="http://www.pintool.org/docs/39599/Pin/html/">PIN</a>&nbsp;and visualized by VERA. I traced notepad.exe by fixing 2 minutes of execution here the result:</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-OHhtZ567BBs/Tzt9paOnhkI/AAAAAAAAK6Y/wA5CBLGUUnQ/s1600/NotePADUnpacked.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="356" src="http://1.bp.blogspot.com/-OHhtZ567BBs/Tzt9paOnhkI/AAAAAAAAK6Y/wA5CBLGUUnQ/s400/NotePADUnpacked.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: justify;">The blue label represents the Start address (which in this particular case corresponds to OE), yellow color means normal entropy, numbers in labels (you probably cannot see them because the image is too small) are the called addresses. The following image shows the same executable packet by using UPX.&nbsp;</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Mv_vzWxPiik/Tzt_CXQiX3I/AAAAAAAAK6g/CL7-rXqCzAE/s1600/NotePADUPXPAcked.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="341" src="http://2.bp.blogspot.com/-Mv_vzWxPiik/Tzt_CXQiX3I/AAAAAAAAK6g/CL7-rXqCzAE/s400/NotePADUPXPAcked.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: justify;">As you may see the are sections (calls to addresses) that have high entropy (meaning be packed or encrypted) represented with RED labels. This alerts us about the presence of a packer / encryptor. Where the is a continuously low entropy labels (purple) we can find the OE. This because the encryptor / packer STUB finished its job and unpacked / decrypted the executable code giving to the OE the control flow. The following image shows notepad.exe packed by BroExePacker.</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-5xONcroOr9Y/TzuATckYzbI/AAAAAAAAK6o/RupJLJ8UkUM/s1600/NotePADBROExePacker.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="353" src="http://3.bp.blogspot.com/-5xONcroOr9Y/TzuATckYzbI/AAAAAAAAK6o/RupJLJ8UkUM/s400/NotePADBROExePacker.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;">In this case BroExePacker introduces a two levels of compression STUBs, you can easily distinguish them by looking at the red labels that are present in two points during the execution. This shows a typical two stage decompression. A first STUB decompress the function that decompress the real function who will decompress the original byte code (RED -PURPLE-RED-PURPLE). The OE is placed after the second RED labels. The following image shows the same executable (notepad.exe) compressed by the same BroExePacker but by using a different algorithm.</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-dMtGkxL1R9Q/TzuBf7pKnTI/AAAAAAAAK6w/EMrHMvehfUM/s1600/NotePadBROBESTPack.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="326" src="http://4.bp.blogspot.com/-dMtGkxL1R9Q/TzuBf7pKnTI/AAAAAAAAK6w/EMrHMvehfUM/s400/NotePadBROBESTPack.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: justify;">Again, we can easily discover that this executable has been packed, this time with one level STUB. The OE could be in a couple of positions. Experience will help a lot in finding the OE, but this Visualization tool considerably decrease the complexity of such operation. VERA could be integrated to IDA pro by installing an IDA Pro plugin making IDA Pro communicating to VERA through sockets. This integration makes a lot easier the interaction between the tracer (IDA Pro) and the visualization tool VERA. I &nbsp;am not going to cover in this post how to integrate VERA with IDA, but I am rather cover how to use VERA and PIN in a very quick way. Once you download and &nbsp;install VERA from its <a href="http://csr.lanl.gov/vera/">website</a>&nbsp;, &nbsp;you will get the visualization tool (VERA) and a small installation of PIN. &nbsp;PIN is the tracer, the one who will produce the &nbsp;.trace file by executing the analyzed executable, the .trace file who will get VERA to elaborate &nbsp;its diagram. &nbsp;The following picture shows hot to run PIN with VERA template.</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-st7G3fSraoo/TzuGU5ndD5I/AAAAAAAAK64/9S08ZCrkmx4/s1600/Screen+Shot+2012-02-15+at+11.11.50+AM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="200" src="http://2.bp.blogspot.com/-st7G3fSraoo/TzuGU5ndD5I/AAAAAAAAK64/9S08ZCrkmx4/s400/Screen+Shot+2012-02-15+at+11.11.50+AM.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: justify;">PIN is now running and tracing the analyzed executable. Let it running for a while (the time you decide) and then close the executable in a normal way (File -&gt; Close, or whatever). Now opera VERA and click on Open. Select the file produced by PIN. Now VERA asks you about the original file and ask where to put its own graph file. The following image shows this process</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-det0TbBkuLA/TzuHOJI4ECI/AAAAAAAAK7A/KoE4d1wf2Ws/s1600/Screen+Shot+2012-02-15+at+11.21.16+AM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="278" src="http://3.bp.blogspot.com/-det0TbBkuLA/TzuHOJI4ECI/AAAAAAAAK7A/KoE4d1wf2Ws/s320/Screen+Shot+2012-02-15+at+11.21.16+AM.png" width="320" /></a></div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;">Once you done with that, VERA will take a while and finally it will show you a graphic traced path. You will find more details on VERA and PIN manual.&nbsp;</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;">Summing up, I wanted to describe a new way to figure out if a executable has been packed or encrypted, and a new way to discover the Original Entry Point of the packed/encrypted executable. My experience in this field let me say that this is a great way to proceed and to learn about packers/encrypters.</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=A%20New%20Way%20to%20Detect%20Packers-http%3a%2f%2fmarcoramilli.com%2fpost%2fa-new-way-to-detect-packers%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-new-way-to-detect-packers%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-new-way-to-detect-packers%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-new-way-to-detect-packers%2f&title=A%20New%20Way%20to%20Detect%20Packers" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-new-way-to-detect-packers%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-new-way-to-detect-packers%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
