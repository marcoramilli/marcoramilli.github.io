<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Hacking through images &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Oct 21, 2013</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          â€¢ 500 words 3 min. read
        </div>
        <h1>Hacking through images</h1>
        <section id="post-content" class="article-content post">
          <div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">It's long time I don't write on my own blog (more then two months) and if you look at the history bar on your right you will probably figure out&nbsp; I am slowing down my blog posts a bit if compared to the past years. This happens due the amount of work my security team and I are involved on.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Many different and really important facts happened during the past months, from astonishing NSA revelations to huge BUGs and new Malware kit ready to be purchased. Even if there would be lots to say about all these&nbsp; I will not dig into them.&nbsp;</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Since "things" went public today I want to share a little and dirty python script which embeds javascript code into bmp images letting those images still valid images, ready to be processed from your favorite browser.&nbsp;</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">The following&nbsp; HTML page wants to parse a bmp file and a javascript file which happen to be the same file: 2.bmp. Theoretically the file should be or a bitmap file or a javascript file. <b>Could it be a javacript and an image file at the same time</b> ? The answer should be NO. It couldn't. But let's see what we have.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-3b4u6bzWUwo/UkL_P5UNDiI/AAAAAAAALdo/HlK-aw89q1A/s1600/Screen+Shot+2013-09-25+at+5.20.04+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="101" src="http://1.bp.blogspot.com/-3b4u6bzWUwo/UkL_P5UNDiI/AAAAAAAALdo/HlK-aw89q1A/s400/Screen+Shot+2013-09-25+at+5.20.04+PM.png" width="400" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: justify;">&nbsp;Executing this file you'll find out this result:</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-Jy6jCUuc-R0/UkL_ddq2U2I/AAAAAAAALdw/eWnc5JBe2SE/s1600/Screen+Shot+2013-09-25+at+5.14.13+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="275" src="http://1.bp.blogspot.com/-Jy6jCUuc-R0/UkL_ddq2U2I/AAAAAAAALdw/eWnc5JBe2SE/s400/Screen+Shot+2013-09-25+at+5.14.13+PM.png" width="400" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: justify;">As you can see, both tags succesfully executed. The Image tag is showing the red Bitmap file and the script tag is doing its job by executing a JavaScript. How is it possible ? How did you write such a file ? The following images show more details about the dirty code who generates these beautiful bitmap files.</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-3ZV097iaNJo/UkMANq-imiI/AAAAAAAALd4/z1ohKEI6Ikk/s1600/Screen+Shot+2013-09-25+at+5.15.36+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="276" src="http://3.bp.blogspot.com/-3ZV097iaNJo/UkMANq-imiI/AAAAAAAALd4/z1ohKEI6Ikk/s400/Screen+Shot+2013-09-25+at+5.15.36+PM.png" width="400" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: center;">The creation procedure. </div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-AkRFU4QaW7c/UkMAPVZ_p1I/AAAAAAAALeA/yPBrk7TBZcc/s1600/Screen+Shot+2013-09-25+at+5.15.59+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="335" src="http://2.bp.blogspot.com/-AkRFU4QaW7c/UkMAPVZ_p1I/AAAAAAAALeA/yPBrk7TBZcc/s400/Screen+Shot+2013-09-25+at+5.15.59+PM.png" width="400" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: center;">The&nbsp; substitution procedure.</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;">This is not magic at all. This is just my implementation of the BMP parsing bug many libraries have. The idea behind this python code is to create a valid BMP header within \x2F\x2A (aka \*) and then close up the end of the image through a \x2A\x2F (aka *\). To be a valid JavaScript file, you need to use the --not used-- header (\x42\x4D) as a variable and/or as a part of the code. This is why before the payload you might inject a simple expression like "=1;" or more commonly used "=a;" The following image shows the first part of a forget BMP header to exploit this eakness.</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-o5OMUE21Fu4/UkNOXmBYD4I/AAAAAAAALeQ/EGg2IzaEENg/s1600/Screen+Shot+2013-09-25+at+5.38.46+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="36" src="http://1.bp.blogspot.com/-o5OMUE21Fu4/UkNOXmBYD4I/AAAAAAAALeQ/EGg2IzaEENg/s640/Screen+Shot+2013-09-25+at+5.38.46+PM.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;">BTW if you want to downloade the entire code, grab it&nbsp; <a href="http://pastebin.com/04y7ee3u" target="_blank">here</a> (pasteBIN).&nbsp; </div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;">Run-it as: bmp.py -i image.bmp "alert(\"test\");"</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-_GGOrgPZC8w/UmTQAJfq7rI/AAAAAAAALfA/l_ZosAQIRqE/s1600/Screen+Shot+2013-10-21+at+8.55.33+AM.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="50" src="http://2.bp.blogspot.com/-_GGOrgPZC8w/UmTQAJfq7rI/AAAAAAAALfA/l_ZosAQIRqE/s400/Screen+Shot+2013-10-21+at+8.55.33+AM.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Running Example</td></tr></tbody></table><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;">Don't forget, you might want to use obfuscators to better hide your javascript like the following example:</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: left;">python bmp.py -i 2.bmp "var _0x9c4c=[\"\x48\x65\x6C\x6C\x6F\x20\x57\x6F\x72\x6C\x64\x21\",\"\x0A\",\"\x4F\x4B\"];var a=_0x9c4c[0];function MsgBox(_0xccb4x3){alert(_0xccb4x3+_0x9c4c[1]+a);} ;MsgBox(_0x9c4c[2]);"</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-Jwmgye7_kKg/UmTQ6hPgiMI/AAAAAAAALfI/2qdXrV6KT84/s1600/Screen+Shot+2013-10-21+at+8.58.53+AM.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="47" src="http://4.bp.blogspot.com/-Jwmgye7_kKg/UmTQ6hPgiMI/AAAAAAAALfI/2qdXrV6KT84/s400/Screen+Shot+2013-10-21+at+8.58.53+AM.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Running a more complex Example</td><td class="tr-caption" style="text-align: center;"><br /></td></tr></tbody></table><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;">Enjoy your new hackish tool !</div></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Hacking%20through%20images-http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-images%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-images%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-images%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-images%2f&title=Hacking%20through%20images" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-images%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-images%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
