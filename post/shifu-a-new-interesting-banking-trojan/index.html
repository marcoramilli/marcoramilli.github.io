<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Shifu: A new interesting Banking Trojan &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Sep 3, 2015</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          • 1000 words 5 min. read
        </div>
        <h1>Shifu: A new interesting Banking Trojan</h1>
        <section id="post-content" class="article-content post">
          <div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">Hello everybody, today I'd like to share some infos on "Shifu" a new incredibly interesting banking trojan. At this point you might think:</div><div style="text-align: justify;"><blockquote class="tr_bq">"Why are you writing about Shifu among many other new threats (even more discussed)&nbsp; out there ? "</blockquote></div><div style="text-align: justify;">Well... Shifu is a new banking trojan which actually attacks Japanese banks mostly,&nbsp; it's actually well geo-localized and <u>probably</u> it will end up on a specific amount of organizations, but what fascinates me is the way it implements many features by copying what have done so far some of the "best in class" known Malware. Shifu implements the following features:</div><ul style="text-align: justify;"><li><b>Domain Generation Algorithm (DGA)</b>: Shifu uses the Shiz Trojan’s DGA. The exposed algorithm itself is easy to find online, and the developers behind Shifu have elected to use it for the generation of random domain names for covert botnet communications.&nbsp;</li><li><b>Theft From Bank Apps</b>: Theft of passwords, authentication token files, user certificate keys and sensitive data from Java applets is one of Shifu’s principal mechanisms. This type of modus operandi is familiar from Corcow’s and Shiz’s codes. Both Trojans used these mechanisms to target the banking applications of Russia- and Ukraine-based banks. Shifu, too, targets Russian banks as part of its target list in addition to Japanese banks.</li><li>&nbsp;<b>Anti-Sec</b>: Shifu’s string obfuscation and anti-research techniques were taken from Zeus VM (in its Chtonik/Maple variation), including anti-VM and the disabling of security tools and sandboxes.&nbsp;</li><li><b>Stealth</b>: Part of Shifu’s stealth techniques are unique to the Gozi/ISFB Trojan, and Shifu uses Gozi’s exact same command execution scheme to hide itself in the Windows file system.</li><li><b>Config</b>: The Shifu Trojan is operated with a configuration file written in XML format — not a common format for Trojans, and similar to the Dridex Trojan’s configuration (Dridex is a Bugat offspring).&nbsp;</li><li><b>Wipe System Restore</b>: Shifu wipes the local System Restore point on infected machines in a similar way to the Conficker worm, which was popular in 2009.&nbsp;</li><li><b>Commuication</b> <b>protocol</b>: Shifu implements an SSL communication layer based on a Self-signed certificate. The implemented module reminds analysts to the one used on Dyre Trojan campains in Late 2015.</li></ul><div style="text-align: justify;">Another interesting feature is about <b>Point</b> <b>Of</b> <b>Sales</b>. To make matters worse, Shifu searches for specific POS memory strings (and processes). If it finds a POS trace it starts a "stealing credit card numbers" procedure.</div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-Th6zPK7mEjk/Vec_q77UjKI/AAAAAAAAMZ0/U_gWZE-fQrY/s1600/Screen%2BShot%2B2015-09-02%2Bat%2B20.27.16.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="258" src="http://4.bp.blogspot.com/-Th6zPK7mEjk/Vec_q77UjKI/AAAAAAAAMZ0/U_gWZE-fQrY/s320/Screen%2BShot%2B2015-09-02%2Bat%2B20.27.16.png" width="320" /></a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Last but not least Shifu makes sure none else will own the attacked system. Once it gets installed on the victim machine is starts an "AV" procedure (forgive me, is not actually an AV procedure, but it makes the idea) which locates "suspicious" files and&nbsp; denies their installation. According to IBM Security Intelligence's report (<a href="https://securityintelligence.com/shifu-masterful-new-banking-trojan-is-attacking-14-japanese-banks/">here</a>) the Malware is likely developed by a Russian group.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Let's get dirty hands on it performing basics Reverse Engineering actions to see what are the real countermeasures it adopts.&nbsp; From the IBM Report (linked abouve) you may find the Malware signature (NmE5ZDRhMzIzOTg3NDg5YzhlOGI1NTc2ZjY3YjJjOTQ) which can be used into common online SandBox systems to look for samples. As you might observe the sample I've got implemets some anti-debugging techniques as well as some basic SandBox evasion techniques (for more information please have a look to <a href="http://www.malwarestats.org/">malwarestats</a>):</div><div style="text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-e65qzMkFE7s/VedM0w1z1dI/AAAAAAAAMaE/SY19RxQCvgs/s1600/Screen%2BShot%2B2015-09-02%2Bat%2B21.20.11.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="400" src="http://1.bp.blogspot.com/-e65qzMkFE7s/VedM0w1z1dI/AAAAAAAAMaE/SY19RxQCvgs/s400/Screen%2BShot%2B2015-09-02%2Bat%2B21.20.11.png" width="185" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">GetLastError, IsDebuggerPresent, GetVolumeInformations, etc..</td><td class="tr-caption" style="text-align: center;"><br /></td></tr></tbody></table><div style="text-align: justify;">&nbsp;An interesting sequences of API calls were found: <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683212%28v=vs.85%29.aspx"><b>GetProcessAddress</b></a>&nbsp; (Retrieve the address of of an exported function or variable from the specified dynamic-link library) -- <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366898%28v=vs.85%29.aspx"><b>VirtualProtect</b></a> (stack) (Changes the protection on a region of committed pages in the virtual address space of the calling      process.) -- <b>VirtualAlloc</b> (Reserves, commits, or changes the state  of a region of pages in the virtual address space of the calling process.      Memory allocated by this function is automatically initialized to zero.) -- <b>Sleep</b> (Suspends the execution of the current thread until the time-out interval elapses.) -- <b>VirtualAlloc</b> --&nbsp;</div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-qDFrdhN4G6o/VedOJMcjvUI/AAAAAAAAMaU/fCcrWrU1X2M/s1600/Screen%2BShot%2B2015-09-02%2Bat%2B21.28.56.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="297" src="http://1.bp.blogspot.com/-qDFrdhN4G6o/VedOJMcjvUI/AAAAAAAAMaU/fCcrWrU1X2M/s320/Screen%2BShot%2B2015-09-02%2Bat%2B21.28.56.png" width="320" /></a><a href="http://2.bp.blogspot.com/-JBrWT6xvmhA/VedN_L7qZEI/AAAAAAAAMaM/yoTybsTOCVc/s1600/Screen%2BShot%2B2015-09-02%2Bat%2B21.27.04.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://2.bp.blogspot.com/-JBrWT6xvmhA/VedN_L7qZEI/AAAAAAAAMaM/yoTybsTOCVc/s320/Screen%2BShot%2B2015-09-02%2Bat%2B21.27.04.png" width="156" /></a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Another interesting pattern found during the simple static analysis performed phase (showed on the following image) is the dynamically loaded Library pattern (previous downloaded).&nbsp; As you may observe on row 2861 the system points out to a specific location and call LoadLibraryA to load it into memory. </div><div style="text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-Pl87oWJO2Jc/VedPDuVRXxI/AAAAAAAAMac/-B3SQjJmUYI/s1600/Screen%2BShot%2B2015-09-02%2Bat%2B21.32.14.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="161" src="http://1.bp.blogspot.com/-Pl87oWJO2Jc/VedPDuVRXxI/AAAAAAAAMac/-B3SQjJmUYI/s400/Screen%2BShot%2B2015-09-02%2Bat%2B21.32.14.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Dynamically Loaded DLL</td></tr></tbody></table><div style="text-align: justify;">Dynamic Analysis clearly shows Sample's RAT features by spawning a shell (on my machine PID: 1388 within Parent PID: 788 owning to the executed Sample ) and executing commands. Unfortunately the evasion techniques detected the SandBox execution. The following image shows the check of Python presence, which often is one of the detection mechanisms (How many common users have Python on their Windows Machines ? Not much, really).</div><div style="text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-DuDD_d3NG-A/VedR5gPAK0I/AAAAAAAAMao/DGuv9T-0eGE/s1600/Screen%2BShot%2B2015-09-02%2Bat%2B21.44.05.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="105" src="http://3.bp.blogspot.com/-DuDD_d3NG-A/VedR5gPAK0I/AAAAAAAAMao/DGuv9T-0eGE/s400/Screen%2BShot%2B2015-09-02%2Bat%2B21.44.05.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Python Detection</td></tr></tbody></table><div style="text-align: justify;"><br /></div><div style="text-align: justify;">After a simple de-obfuscation round (Visual C Packer was detected) the analyst could appreciate the command line parser. Probably the one used to communicate through Command and Control (not much further analysis has been performed)</div><div style="text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-24x4gth_GBk/VedYIOJGcyI/AAAAAAAAMa4/B3ORCIc086w/s1600/CMDLine.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="230" src="http://3.bp.blogspot.com/-24x4gth_GBk/VedYIOJGcyI/AAAAAAAAMa4/B3ORCIc086w/s400/CMDLine.png" width="400" /></a></td></tr><tr align="justify"><td class="tr-caption">Command Line Parser</td></tr></tbody></table><div style="text-align: justify;">Network wise the sample embeds the following addresses:</div><ul style="text-align: justify;"><li>download.windowsupdate.com                 (191.234.4.50). Noisy maker</li><li>eboduftazce-ru.com (188.42.254.65). Much more interesting because geolocalized in China and the domain has changed at least two servers during the last year.</li></ul><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-pXu_EmGJy_M/VefZ_NxwWII/AAAAAAAAMbI/mR-x1Q565Qs/s1600/Screen%2BShot%2B2015-09-03%2Bat%2B07.25.26.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="218" src="http://4.bp.blogspot.com/-pXu_EmGJy_M/VefZ_NxwWII/AAAAAAAAMbI/mR-x1Q565Qs/s400/Screen%2BShot%2B2015-09-03%2Bat%2B07.25.26.png" width="400" />&nbsp;</a></td><td style="text-align: center;"></td></tr><tr align="justify"><td class="tr-caption">WhoIS</td><td class="tr-caption"></td><td class="tr-caption"></td><td class="tr-caption"></td></tr></tbody></table><div style="text-align: justify;">A simple nmap scan on it shows up-and-running a nginx server on both ports 80 and 443, used to comunicate to Malware and a ssh daemon active on standard port and and an interesting port 53 TCP opened. Statically analized behaviour presents the following TimeLine (click on it to enlarge):</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-bG7ba9HxxzM/Vefb7A-g8cI/AAAAAAAAMbU/kdqp1uMnd3I/s1600/Screen%2BShot%2B2015-09-03%2Bat%2B07.33.49.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="31" src="http://3.bp.blogspot.com/-bG7ba9HxxzM/Vefb7A-g8cI/AAAAAAAAMbU/kdqp1uMnd3I/s400/Screen%2BShot%2B2015-09-03%2Bat%2B07.33.49.png" width="400" /></a></td></tr><tr align="justify"><td class="tr-caption">Behaviour Time Line</td></tr></tbody></table><div style="text-align: justify;">Not really a significant one but the cmd.exe spawned feels like an hero. Concluding my post I wanted to impress on my pages this significant piece of Malware which embeds many different techniques borrowed from many older Malware underlining a new Malware writers skill sets, able to make harder and harder piece of code as their wish (just by adding feature from different Malwares).</div><br /></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Shifu%3a%20A%20new%20interesting%20Banking%20Trojan-http%3a%2f%2fmarcoramilli.com%2fpost%2fshifu-a-new-interesting-banking-trojan%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fshifu-a-new-interesting-banking-trojan%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fshifu-a-new-interesting-banking-trojan%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fshifu-a-new-interesting-banking-trojan%2f&title=Shifu%3a%20A%20new%20interesting%20Banking%20Trojan" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fshifu-a-new-interesting-banking-trojan%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fshifu-a-new-interesting-banking-trojan%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
