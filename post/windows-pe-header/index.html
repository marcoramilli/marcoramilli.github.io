<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Windows PE Header &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Dec 3, 2010</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          â€¢ 1100 words 6 min. read
        </div>
        <h1>Windows PE Header</h1>
        <section id="post-content" class="article-content post">
          <div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">Hi Folks, during the past days a couple of students asked me a question about Windows PE header. Well, I supposed the PE was a "kind of" well known structure, instead it seems to be pretty much obscured for most of my people.</span></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">So I am going to resume very very briefly what PE is giving some useful pictures harvested out here.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Each executable file has a Common Object File Format <b>COFF </b>which is used from the OS loader to run the program. Windows Portable Executable (<b>PE</b>) is one of the COFF available in todays OS. For example the Executable Linking File (ELF) is the main Linux COFF. </div><br /><blockquote><br /><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">Microsoft migrated to the PE format with the introduction of the Windows NT 3.1 operating system. All later versions of Windows, including Windows 95/98/ME, support the file structure. The format has retained limited legacy support to bridge the gap between DOS-based and NT systems. For example, PE/COFF headers still include an MS-DOS executable program, which is by default a stub that displays the simple message "This program cannot be run in DOS mode" (or similar). PE also continues to serve the changing Windows platform. Some extensions include the .NET PE format (see below), a 64-bit version called PE32+ (sometimes PE+), and a specification for Windows CE.</span></div></blockquote><br /><br /><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">Nowadays the Windows PE header has the following structure (Click To Make it Bigger) .</span></div><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://1.bp.blogspot.com/_gK7b9huwiwY/TPi8wHzKWjI/AAAAAAAAKgw/AXZokBLtgUQ/s1600/PE1.png"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 400px; height: 153px;" src="http://1.bp.blogspot.com/_gK7b9huwiwY/TPi8wHzKWjI/AAAAAAAAKgw/AXZokBLtgUQ/s400/PE1.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5546390476020144690" /></a><br /><br /><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">MZ are the first 2 bytes you will see in any PE file opened in a hex editor. The DOS header occupies the first 64 bytes of the file - ie the first 4 rows seen in the hexeditor in the picture below. The last DWORD before the DOS stub begins contains 00h 01h 00h 00h, which is the offset where the PE header begins. </span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">The DOS stub is the piece of software that runs if the executable is run from DOS environment (for example DOS shell). For retro-compatibility it often executes a printf("This program must be run under Win32");.</span></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">The PE header begins with its signature 50h, 45h, 00h, 00h (the letters "PE" followed by two terminating zeroes).</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">If in the Signature field of the PE header, you find an NE signature here rather than a PE, you're working with a 16-bit Windows New Executable file. Likewise, an LE in the signature field would indicate a Windows 3.x virtual device driver (VxD). An LX here would be the mark of a file for OS/2 2.0. FileHeader is the next 20 bytes of the PE file and contains info about the physical layout &amp; properties of the file e.g. number of sections. OptionalHeader is always present and forms the next 224 bytes. It contains info about the logical layout inside the PE file e.g. AddressOfEntryPoint. Its size is given by a member of FileHeader. The structures of these members are also defined in windows.inc.</span></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">The PE header is defined as follows:</span></div><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_gK7b9huwiwY/TPjADwNRoWI/AAAAAAAAKg4/w3Z-8PGwac0/s1600/PE2.png"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 354px; height: 196px;" src="http://3.bp.blogspot.com/_gK7b9huwiwY/TPjADwNRoWI/AAAAAAAAKg4/w3Z-8PGwac0/s400/PE2.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5546394111819489634" /></a><br /><br /><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">Not all these section must be used, but you need to modify the <span style="font-style:italic;">NumberOfSections</span> to add or delete sections from a PE file. The best way to analyze those section is by using PEExplorer or PEID. The following image shows the PEID in use.</span></div><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://2.bp.blogspot.com/_gK7b9huwiwY/TPjCOyz4fJI/AAAAAAAAKhA/E__LayssyEM/s1600/PE3.png"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 400px; height: 187px;" src="http://2.bp.blogspot.com/_gK7b9huwiwY/TPjCOyz4fJI/AAAAAAAAKhA/E__LayssyEM/s400/PE3.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5546396500520107154" /></a><br /><br /><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; "><span style="font-style:italic;">EntryPoint</span> is The Relative Virtual Addresses (RVA) of the first instruction that will be executed when the PE loader is ready to run the PE file. If you want to divert the flow of execution right from the start, you need to change the value in this field to a new RVA and the instruction at the new RVA will be executed first. Executable packers usually redirect this value to their decompression stub, after which execution jumps back to the original entry point of the app the OEP. Of further note is the Starforce protection in which the CODE section is not present in the file on disk but is written into virtual memory on execution. </span></div><div style="text-align: justify;"><br /></div><span style="font-style:italic;"><div style="text-align: justify;"><span class="Apple-style-span" style="font-style: normal; font-size: 15.8333px; "><span style="font-style:italic;">ImageBase</span> is the preferred load address for the PE file. For example, if the value in this field is 400000h, the PE loader will try to load the file into the virtual address space starting at 400000h. The word "preferred" means that the PE loader may not load the file at that address if some other module already occupied that address range. In 99% of cases it is 400000h.</span></div></span><div style="text-align: justify;"><br /></div><span style="font-style:italic;"><div style="text-align: justify;"><span class="Apple-style-span" style="font-style: normal; font-size: 15.8333px; "><span style="font-style:italic;">SectionAlignment</span> is the granularity of the alignment of the sections in memory. For example, if the value in this field is 4096 (1000h), each section must start at multiples of 4096 bytes. If the first section is at 401000h and its size is 10 bytes, the next section must be at 402000h even if the address space between 401000h and 402000h will be mostly unused.</span></div></span><div style="text-align: justify;"><br /></div><span style="font-style:italic;"><div style="text-align: justify;"><span class="Apple-style-span" style="font-style: normal; font-size: 15.8333px; "><span style="font-style:italic;">FileAlignment</span> is the granularity of the alignment of the sections in the file. For example, if the value in this field is 512 (200h), each section must start at multiples of 512 bytes. If the first section is at file offset 200h and the size is 10 bytes, the next section must be located at file offset 400h: the space between file offsets 522 and 1024 is unused/undefined.</span></div></span><div style="text-align: justify;"><br /></div><span style="font-style:italic;"><div style="text-align: justify;"><span class="Apple-style-span" style="font-style: normal; font-size: 15.8333px; "><span style="font-style:italic;">SizeOfImage</span> is the overall size of the PE image in memory. It's the sum of all headers and sections aligned to SectionAlignment.</span></div></span><div style="text-align: justify;"><br /></div><span style="font-style:italic;"><div style="text-align: justify;"><span class="Apple-style-span" style="font-style: normal; font-size: 15.8333px; "><span style="font-style:italic;">SizeOfHeaders</span> is the size of all headers + section table. In short, this value is equal to the file size minus the combined size of all sections in the file. You can also use this value as the file offset of the first section in the PE file.</span></div></span><div style="text-align: justify;"><br /></div><span style="font-style:italic;"><div style="text-align: justify;"><span class="Apple-style-span" style="font-style: normal; font-size: 15.8333px; "><span style="font-style:italic;">DataDirectory</span> It is the final 128 bytes of OptionalHeader, which in turn is the final member of the PE header IMAGE_NT_HEADERS. DataDirectory is an array of 16 IMAGE_DATA_DIRECTORY structures, 8 bytes apiece, each relating to an important data structure in the PE file. Each array refers to a predefined item, such as the import table. The structure has 2 members which contain the location and size of the data structure in question: <span style="font-weight:bold;">VirtualAddress</span> is the relative virtual address (RVA) of the data structure , and <span style="font-weight:bold;">isize</span> contains the size in bytes of the data structure.</span></div></span><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">Summing up the whole PE Header structure in nutshell: </span></div><div style="text-align: justify;"><br /></div><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_gK7b9huwiwY/TPjEvoYC6gI/AAAAAAAAKhI/5dhfPx-toZQ/s1600/PE5.png"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 400px; height: 303px;" src="http://3.bp.blogspot.com/_gK7b9huwiwY/TPjEvoYC6gI/AAAAAAAAKhI/5dhfPx-toZQ/s400/PE5.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5546399263677934082" /></a><br /><br /><br /><div style="text-align: justify;"><span class="Apple-style-span" style="font-size: 15.8333px; ">Alright this was a short description of the much more complex Windows PE header. I believe this is what everybody (of course I am not talking about grandma, but security skilled guys)  should know about Windows PE. After that when you need to deal with PE header obviously these information aren't enough to attack or to reverse engineer a PE header, so I suggest to look into the most authoritative guides: <a href="http://www.osdever.net/documents/PECOFF.pdf">this</a>, <a href="http://www.skyfree.org/linux/references/coff.pdf">this</a> and <a href="http://www.woodmann.com/RCE-CD-SITES/Library/M_Pietrek_Book/PietrekBook.pdf">this</a>.</span></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Windows%20PE%20Header-http%3a%2f%2fmarcoramilli.com%2fpost%2fwindows-pe-header%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fwindows-pe-header%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fwindows-pe-header%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fwindows-pe-header%2f&title=Windows%20PE%20Header" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fwindows-pe-header%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fwindows-pe-header%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
