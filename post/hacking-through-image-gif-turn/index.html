<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Hacking through image: GIF turn &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Jan 6, 2014</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          â€¢ 500 words 2 min. read
        </div>
        <h1>Hacking through image: GIF turn</h1>
        <section id="post-content" class="article-content post">
          <div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">In one of my previous posts I <a href="http://marcoramilli.blogspot.it/2013/10/hacking-through-images.html" target="_blank">described</a> a way to hack through images. That time I showed how a valid BMP file could be a valid JS file as well, hiding Javascript operations. Today it's time to describe how this attack work with a more common web file format: .GIF. <a href="http://code.google.com/p/corkami/" target="_blank">Ange</a> commented on my previous post showing me out his great work on the topic. I recomend to have a look to his study (<a href="https://github.com/wopot/jsgifkeylogger" target="_blank">here</a>). Following my quick 'n dirty python implementation on the technique.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">The following&nbsp; HTML page wants to parse a GIF file and a JavaScript file  which happen to be the same file: 1.gif_malw.gif. Theoretically the file should  be or a valid GIF file or a valid JavaScript file. <b>Could it be a valid javacript and a valid image file at the same time</b> ? The answer should be NO. But properly forging the file the answer is YES, it is. Let's assume to have the following HTML page.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-04kULGuoVYg/Usmfkk242CI/AAAAAAAALhc/lw4h8A7_u1M/s1600/Screen+Shot+2014-01-05+at+19.07.00.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-04kULGuoVYg/Usmfkk242CI/AAAAAAAALhc/lw4h8A7_u1M/s400/Screen+Shot+2014-01-05+at+19.07.00.png" height="80" width="400" /></a></div><br />Browsing this file you'll find out this result:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-G9eDzPHZC8I/UsmgROiBU_I/AAAAAAAALhk/LuUWzoRFi9Q/s1600/Screen+Shot+2014-01-05+at+19.10.00.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-G9eDzPHZC8I/UsmgROiBU_I/AAAAAAAALhk/LuUWzoRFi9Q/s400/Screen+Shot+2014-01-05+at+19.10.00.png" height="231" width="400" /></a></div><br /><div style="text-align: justify;">As you can see, both tags (img and script) are succesfully executed. The Image tag is showing  the black GIF file and the script tag is doing its gret job by executing a  JavaScript (alert('test')). How is it possible ? The  following image show one detail about the dirty code who generates the&nbsp; beautiful GIF file.&nbsp;</div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-qXEc_XBhbjo/UsmhP8CAiDI/AAAAAAAALhw/OFYSD4U7n9g/s1600/Screen+Shot+2014-01-05+at+19.14.12.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-qXEc_XBhbjo/UsmhP8CAiDI/AAAAAAAALhw/OFYSD4U7n9g/s400/Screen+Shot+2014-01-05+at+19.14.12.png" height="165" width="400" /></a></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">This is not magic at all. This is just my implementation of the GIF  parsing bug many libraries have. The idea behind this python code is to  create a valid GIF header within \x2F\x2A (aka \*) and then close up the  end of the image through a \x2A\x2F (aka *\). Before injecting the payload you might  inject a simple expression like "=1;" or the most commonly used "=a;" in order to use all the GIF block as a variable. The  following image shows the first part of a forget GIF header to exploit  this weakness (click&nbsp; to enlarge).&nbsp;</div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-LJXrzssxE6k/Usmj3Kx045I/AAAAAAAALiE/rfgvyVy2bXw/s1600/Screen+Shot+2014-01-05+at+19.25.26.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-LJXrzssxE6k/Usmj3Kx045I/AAAAAAAALiE/rfgvyVy2bXw/s400/Screen+Shot+2014-01-05+at+19.25.26.png" height="253" width="400" /></a></div><div style="text-align: center;"><br /><div style="text-align: justify;">After having injected the "padding" chars (in this case I call padding the " '=a;' characters", which are useful to JS interpreter) it's time to inject the real payload. The small script I've realized automizes this process and you might want to run it in a really easy way:</div><div style="text-align: justify;">&nbsp; </div><div style="text-align: center;">Run-it as: <b>gif.py -i image.gif "alert(\"test\");"</b></div></div><div style="text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-Rg3P1Z5H9nk/Usmi1imuXCI/AAAAAAAALh8/kpwwrH2dL3o/s1600/Screen+Shot+2014-01-05+at+19.21.41.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-Rg3P1Z5H9nk/Usmi1imuXCI/AAAAAAAALh8/kpwwrH2dL3o/s400/Screen+Shot+2014-01-05+at+19.21.41.png" height="48" width="400" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: justify;">Don't forget, you might want to use obfuscators to better hide your javascript like the following example:</div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;"></div><div class="separator" style="clear: both; text-align: left;"><b>python gif.py -i 2.gif "var  _0x9c4c=[\"\x48\x65\x6C\x6C\x6F\x20\x57\x6F\x72\x6C\x64\x21\",\"\x0A\",\"\x4F\x4B\"];var  a=_0x9c4c[0];function MsgBox(_0xccb4x3){alert(_0xccb4x3+_0x9c4c[1]+a);}  ;MsgBox(_0x9c4c[2]);"</b></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">If you wat to check and/or download the code <a href="http://pastebin.com/6yUbfGX5" target="_blank">click here</a>. </div><div class="separator" style="clear: both; text-align: left;">Enjoy your new hackish tool ! </div><div class="separator" style="clear: both; text-align: justify;"><br /></div><div style="text-align: center;"><br /></div></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Hacking%20through%20image%3a%20GIF%20turn-http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-image-gif-turn%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-image-gif-turn%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-image-gif-turn%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-image-gif-turn%2f&title=Hacking%20through%20image%3a%20GIF%20turn" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-image-gif-turn%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fhacking-through-image-gif-turn%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
