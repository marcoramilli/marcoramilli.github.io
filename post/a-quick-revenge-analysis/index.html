<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> A quick REVENGE Analysis &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Mar 20, 2017</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          â€¢ 1400 words 7 min. read
        </div>
        <h1>A quick REVENGE Analysis</h1>
        <section id="post-content" class="article-content post">
          <div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">Another free weekend, another suspicious link provided by a colleague of mine and another compelling feeling to understand "how it works". &nbsp;The following analysis is made "just for fun" and is not part of my professional analyses which have to follows a complete different process before being released. So please consider it as a "sport activity".</div><br />A colleague of mine provided me a suspicious link which I decided to analyze.<br /><br /><div style="text-align: justify;">The infection starts by redirecting the browser to the page "<span style="color: blue;">see.aliharperweddings.com</span>" through a GET request with the following parameters:</div><blockquote class="tr_bq">biw=diamonds.104wh99.406v6e7i0&amp;que=diamonds.124if80.406v5h6e9&amp;qtuif=3654&amp;fix=diamonds.108bf93.406p9e7i4&amp;oq=CeliDpvspJOdZNQOyj0SGfwZkm4pcBwhH9Pqqj0bWmxCag57W9CW9UU4HupE&amp;q=z3jQMvXcJwDQDoTBMvrESLtEMU_OHEKK2OH_783VCZ39JHT1vvHPRAPytgW&amp;ct=diamonds&amp;tuif=6124</blockquote><div style="text-align: justify;">The page is not build to return rendered content but rather to return three different scripts. Indeed the returned visible page holds a weird displayed content as follows:</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-t77P5Evx--Y/WM60JXvJjiI/AAAAAAAAN6g/BnABNTKLmWA77wu9K1N8aDwTkqVZONaoQCLcB/s1600/EK_1.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="131" src="https://3.bp.blogspot.com/-t77P5Evx--Y/WM60JXvJjiI/AAAAAAAAN6g/BnABNTKLmWA77wu9K1N8aDwTkqVZONaoQCLcB/s640/EK_1.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Weird visible content by: see.aliharperweddings.com</td></tr></tbody></table><br /><div style="text-align: justify;">Getting a little deeper on the page source code it is easy to experience nice obfuscated scripts, which look like (at least to my experience) a first infection stage. Let's have fun and try to understand how this new sample works. The following image shows an obfuscated piece of code portion. We are getting into the first stage of analysis.</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-8RDPO4KDLRs/WM69nsXU93I/AAAAAAAAN6w/4vCkqIRPNc0mirWZof5vTxbWMvWN1RUhwCLcB/s1600/EK_obfuscation_1.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="196" src="https://3.bp.blogspot.com/-8RDPO4KDLRs/WM69nsXU93I/AAAAAAAAN6w/4vCkqIRPNc0mirWZof5vTxbWMvWN1RUhwCLcB/s400/EK_obfuscation_1.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">First Stage: The fun begins.</td></tr></tbody></table><br /><div style="text-align: justify;">Just few steps on google <a href="https://developers.google.com/v8/" target="_blank">V8 engine</a>&nbsp;to de-obfuscate the first stage which uses a couple of techniques to run VBscript on the target machine. The first implemented trick, as shown in next image, is to use the classic &nbsp;but "ever green"&nbsp;<b>window.execScript</b> which is no longer supported on Explorer &gt;= 11. execScript takes two parameters: "the code to be run" and the "used programming language". The function invokes the right interpreter depending on "programming language" parameter.</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-AZQYRzVVnXM/WM6_VQYZ26I/AAAAAAAAN68/F9XhnzQfzhcRLcMce3W8tTKlRoyzZZ6bgCLcB/s1600/EK_Obfuscation_2.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="258" src="https://1.bp.blogspot.com/-AZQYRzVVnXM/WM6_VQYZ26I/AAAAAAAAN68/F9XhnzQfzhcRLcMce3W8tTKlRoyzZZ6bgCLcB/s400/EK_Obfuscation_2.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Second Stage: Running VBScript</td></tr></tbody></table><br />The second trick is to use <b>eval </b>to de-obfuscate the second stage and later on to run its functions through <b>VBArray</b> technique. &nbsp;Decoding the second stage was easier if compared to the first stage since less obfuscation rounds are involved. Once de-obfuscated the second stage I've run into another "browser" stage (let's call it Third Stage) written in <b>VisualBasic</b> Language as follows:<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-rhk1li0uPlk/WM7CucyY9TI/AAAAAAAAN7I/5d3Z1MZjF8AGnUmE_3EtHA5_qJpSp3yygCLcB/s1600/Schermata%2B2017-03-19%2Balle%2B18.37.18.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="208" src="https://1.bp.blogspot.com/-rhk1li0uPlk/WM7CucyY9TI/AAAAAAAAN7I/5d3Z1MZjF8AGnUmE_3EtHA5_qJpSp3yygCLcB/s400/Schermata%2B2017-03-19%2Balle%2B18.37.18.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Third Stage: The VBScript saving Windows PE</td></tr></tbody></table>The resulting script is quite simple to read no further obfuscated loops were involved. &nbsp;The script per se is quite big so I am not going to describe every single line of code but just the most interesting one (at least in my personal opinion), so let's focalize on the "random function" (showed in the following image) which returns strLen number of "random" letters from a well defined alphabet :).<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-qjAt4AvxQRE/WM7DVQWVYlI/AAAAAAAAN7Q/KJ-tLGhWK0Ewayff1fdm-IG8jD5avV6qQCLcB/s1600/Schermata%2B2017-03-19%2Balle%2B18.43.31.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="110" src="https://1.bp.blogspot.com/-qjAt4AvxQRE/WM7DVQWVYlI/AAAAAAAAN7Q/KJ-tLGhWK0Ewayff1fdm-IG8jD5avV6qQCLcB/s320/Schermata%2B2017-03-19%2Balle%2B18.43.31.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Third Stage:&nbsp;</span>Implemented "random" function</td></tr></tbody></table><br /><div style="text-align: justify;">This function is used later on to save the PE FileSystemObject into temporary file by using the number "8" as parameter to the <b>rnds</b> function. A nice and dirty IoC would be: "8 letters" from "abcdehiklmnoprstuw02346" alphabet ".exe" into system temporary directory as shown in the next image.&nbsp;</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://2.bp.blogspot.com/-uvP2ir53P3Q/WM7EaYRfqwI/AAAAAAAAN7Y/dxATja5YEhgpu4qGaJDJBloHzQ6XHeGSgCLcB/s1600/Schermata%2B2017-03-19%2Balle%2B18.46.34.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="71" src="https://2.bp.blogspot.com/-uvP2ir53P3Q/WM7EaYRfqwI/AAAAAAAAN7Y/dxATja5YEhgpu4qGaJDJBloHzQ6XHeGSgCLcB/s320/Schermata%2B2017-03-19%2Balle%2B18.46.34.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Third Stage:&nbsp;</span>Saving PE Object using 8 "random" (not really) characters</td></tr></tbody></table><br />The FileSystemObject is then executed through the <b>WScript.Shell</b> technique as shown in the next image.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-hXPxfTIED7A/WM7G2g4LzCI/AAAAAAAAN7k/DL3CNmeUCAoJQpW035RU9sFkAbN_D2sAwCLcB/s1600/Schermata%2B2017-03-19%2Balle%2B18.57.25.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="95" src="https://3.bp.blogspot.com/-hXPxfTIED7A/WM7G2g4LzCI/AAAAAAAAN7k/DL3CNmeUCAoJQpW035RU9sFkAbN_D2sAwCLcB/s320/Schermata%2B2017-03-19%2Balle%2B18.57.25.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Third Stage:&nbsp;</span>Running the fake shell32.dll</td></tr></tbody></table><br />A <b>key</b> argument is defined as "<u>gexywoaxor</u>" and a <b>stream</b> is taken from an url as shown in the following image.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-6tONIExhA0M/WM7JMY3gCtI/AAAAAAAAN70/G0J6mTDD4CYeFrFT9PEH2bSFwQu6ulDUACLcB/s1600/Schermata%2B2017-03-19%2Balle%2B19.02.12.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="20" src="https://3.bp.blogspot.com/-6tONIExhA0M/WM7JMY3gCtI/AAAAAAAAN70/G0J6mTDD4CYeFrFT9PEH2bSFwQu6ulDUACLcB/s400/Schermata%2B2017-03-19%2Balle%2B19.02.12.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Third Stage:&nbsp;</span>Key and Stream</td></tr></tbody></table><br />A special function is crafted to <b>decrypt</b> the stream having as a <b>key</b> the defined one. The decoded stream is getting saved and launched according to the fake <b>shell32.dll</b>.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-QNniv-ukLOo/WM7JuaKmruI/AAAAAAAAN78/37cbZPylXHUhhlmEQAfd6ZLqpfgJo2KeACLcB/s1600/Schermata%2B2017-03-19%2Balle%2B19.08.13.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="320" src="https://3.bp.blogspot.com/-QNniv-ukLOo/WM7JuaKmruI/AAAAAAAAN78/37cbZPylXHUhhlmEQAfd6ZLqpfgJo2KeACLcB/s320/Schermata%2B2017-03-19%2Balle%2B19.08.13.png" width="315" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Third Stage:&nbsp;</span>Decryption stream function (key=&nbsp;gexywoaxor)<br /></td></tr></tbody></table><div style="text-align: justify;">Most of you would recognize <b>RIG Exploit kit </b>which used to decrypt streaming (ADOBE StreamObj) objects through inline xor. That decrypt function would not use a simple xor, and for such a reason I would consider it as new version of RIG Exploit Kit. The overall behavior looks like standard RIG EK having threes infection browser scripts and stream decoding procedure.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Finally I've got a Windows PE on my temporary directory and a script launching it from browser !&nbsp;</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Let's move on and see what it does. A first run the PE file gets information from its Command and Control server which, on my time, happened to be:&nbsp;<span style="background-color: rgba(0, 0, 0, 0.901961); color: #28fe14; font-family: &quot;Andale Mono&quot;; font-size: 12px; font-variant-ligatures: no-common-ligatures;">193.70.90.120 (France)</span></div><style type="text/css">p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Andale Mono'; color: #28fe14; background-color: #000000; background-color: rgba(0, 0, 0, 0.9)} span.s1 {font-variant-ligatures: no-common-ligatures} </style>  <div style="text-align: justify;">It downloaded a Public Key (maybe for encrypting files ?) as follows:</div><div style="text-align: justify;"><br /></div><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-MKRjVtqSdcQ/WM7MNmEmlBI/AAAAAAAAN8I/XT-OWMbhAkwssmJzwlSOQFoHsh85NUmEgCLcB/s1600/KeyExchange.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="206" src="https://3.bp.blogspot.com/-MKRjVtqSdcQ/WM7MNmEmlBI/AAAAAAAAN8I/XT-OWMbhAkwssmJzwlSOQFoHsh85NUmEgCLcB/s320/KeyExchange.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Fourth Stage:&nbsp;</span>Downloaded Public Key</td></tr></tbody></table>This behavior reminds me a romantic Ransomware attack, which happens to fit pretty well with RIG distribution rings. The sample starts with simple http GET but later on it keeps trace of its malicious activity (encrypted files) by posting, on the same C&amp;C, the number of encrypted files and a unique serial number as well. The sample returns back two parameters: <b>id</b> and <b>count</b>.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-ts-rJjKtBWs/WM7Ne5aAIDI/AAAAAAAAN8Q/2AB8ZqjwCz8zTLoniRlAcO9F3LT-gXhsACLcB/s1600/Schermata%2B2017-03-19%2Balle%2B19.25.56.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="74" src="https://1.bp.blogspot.com/-ts-rJjKtBWs/WM7Ne5aAIDI/AAAAAAAAN8Q/2AB8ZqjwCz8zTLoniRlAcO9F3LT-gXhsACLcB/s320/Schermata%2B2017-03-19%2Balle%2B19.25.56.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Fourth Stage:&nbsp;</span>POST to C&amp;C</td></tr></tbody></table><br /><div style="text-align: justify;"><b>id</b> is different for every infection while it could be consider as a unique constant for a given one. <b>count</b>&nbsp;constantly increases its value as a counter depending to the number of encrypted files.</div><div style="text-align: justify;">The sample presents some tricks to control the running environments such as (but not limited to): IsDebugPresent and VolumeChecking. The sample is a multi-thread encryptor which spawns an encrypting thread for each found system folder (limiting to 10 per times). The sample is not packed/encrypted from a well known packer/encryptor as the following image shows, but the real code (payload) is encoded into a Fourth Stage (let me define the Windows PE as fourth stage of infection).</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://4.bp.blogspot.com/-1Fbb5JvsnOY/WM7PGrt4skI/AAAAAAAAN8c/0g2W0Xn3vXQpx8uisErGyirupc4F7ra4QCLcB/s1600/Schermata%2B2017-03-19%2Balle%2B19.33.40.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="167" src="https://4.bp.blogspot.com/-1Fbb5JvsnOY/WM7PGrt4skI/AAAAAAAAN8c/0g2W0Xn3vXQpx8uisErGyirupc4F7ra4QCLcB/s320/Schermata%2B2017-03-19%2Balle%2B19.33.40.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Fourth Stage:&nbsp;</span>No known packers/encrypters are found</td></tr></tbody></table><br /><div style="text-align: justify;">The following image shows the real payload dynamically build in the heap of the fourth stage. As analyst I decided to not extract it but rather following on the original sample in order to understand how happens the control flow switch.</div><br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-ylCjIc1sE8Q/WM7QO3zxsaI/AAAAAAAAN8k/6tysffW0zig734VyU99ZvkCspPCG3mgMACLcB/s1600/Schermata%2B2017-03-19%2Balle%2B00.01.02.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="170" src="https://3.bp.blogspot.com/-ylCjIc1sE8Q/WM7QO3zxsaI/AAAAAAAAN8k/6tysffW0zig734VyU99ZvkCspPCG3mgMACLcB/s400/Schermata%2B2017-03-19%2Balle%2B00.01.02.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Stage Fifth: HEAP built payload&nbsp;</td></tr></tbody></table><br />The fifth stage is run by the following code which after having built the payload straight into the memory gets the control flow by simple dynamic "call" to dynamic memory<i> [ebp+var_4]</i>.<br /><br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-ao73QWAVYXw/WM7QyyT4k_I/AAAAAAAAN8s/UIxU15te_cwRO7NIT4cayfuDY5o-54ajACLcB/s1600/Schermata%2B2017-03-19%2Balle%2B08.32.30.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="162" src="https://3.bp.blogspot.com/-ao73QWAVYXw/WM7QyyT4k_I/AAAAAAAAN8s/UIxU15te_cwRO7NIT4cayfuDY5o-54ajACLcB/s400/Schermata%2B2017-03-19%2Balle%2B08.32.30.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fifth Stage: getting control by call [ebp+var_4]</td></tr></tbody></table>This is the last stage where the payload runs over the folders, read files and encrypt them by using a dynamically loaded cryptbase.dll and the downloaded public key. The payload per-se saves itself and get persistence by infiltrating on register keys. The following images show where the payload copies itself in the target machine<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://2.bp.blogspot.com/-R-6veQKWuF4/WM7RyOKv_9I/AAAAAAAAN80/NFWbDXnMV90Tb6AYRzqOTPKmLWfzQhsfACLcB/s1600/Schermata%2B2017-03-19%2Balle%2B08.39.58.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="166" src="https://2.bp.blogspot.com/-R-6veQKWuF4/WM7RyOKv_9I/AAAAAAAAN80/NFWbDXnMV90Tb6AYRzqOTPKmLWfzQhsfACLcB/s400/Schermata%2B2017-03-19%2Balle%2B08.39.58.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fifth Stage: Payload Persistence</td></tr></tbody></table><div style="text-align: justify;">Te payload saves itself as svchost file creating a folder named Microsofts\ Windows NT\svchost.exe as the most classic payloads does ! Cryptobase.dll functions are dynamically loaded, only few library functions have been involved which takes easy to track them down (the following images show the tracking down imported libraries).</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-TO4JlgDcYF8/WM7TCX-hfXI/AAAAAAAAN88/TJfVDApcwA0o1IgJZKXJRKc7Wrtyhm8igCLcB/s1600/Schermata%2B2017-03-19%2Balle%2B19.49.19.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="142" src="https://1.bp.blogspot.com/-TO4JlgDcYF8/WM7TCX-hfXI/AAAAAAAAN88/TJfVDApcwA0o1IgJZKXJRKc7Wrtyhm8igCLcB/s320/Schermata%2B2017-03-19%2Balle%2B19.49.19.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Stage Fifth: Cryptobase.dll tracking functions</td></tr></tbody></table><div style="text-align: justify;">Finally the SaveFile function write the ransom file: <b># !!!HELP_FILE!!! #.TXT</b>&nbsp; to physical drives having the following content and encrypts file through&nbsp;<b>.REVENGE </b>extension</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-1QlQqanYXY4/WM7UJf2WxJI/AAAAAAAAN9E/GhksJH_kJpEcK4-8fVV0wfMqP9btEoAgQCLcB/s1600/Schermata%2B2017-03-19%2Balle%2B19.55.18.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="277" src="https://1.bp.blogspot.com/-1QlQqanYXY4/WM7UJf2WxJI/AAAAAAAAN9E/GhksJH_kJpEcK4-8fVV0wfMqP9btEoAgQCLcB/s400/Schermata%2B2017-03-19%2Balle%2B19.55.18.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Ransom File</td></tr></tbody></table><div style="text-align: justify;">Since the implemented languages are: <b>English, Italian, German, Polish and Korean &nbsp;</b>it is easy t believe this ransomware attack would target European countries mainly.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">While the infected website (<span style="color: blue; text-align: justify;">see.aliharperweddings.com</span><span style="text-align: justify;">) has promptly been closed (now it belongs to GoDaddy) the Command and Control page is still up and running. Indeed t</span>he command and control appears to be an old vulnerable <b>fake website&nbsp;</b>created on <i>2016-10-07T08:19:40Z&nbsp;</i>weaponized with an ancient content back to November 2014. The website is not a real one, it's a simple "lorem ipsum" with no apparent purpose. The following images shows the apparent not real website.</div><style type="text/css">p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Andale Mono'; color: #28fe14; background-color: #000000; background-color: rgba(0, 0, 0, 0.9)} span.s1 {font-variant-ligatures: no-common-ligatures} </style>  <br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-H5B3L1G0lJA/WM8ERyGwAdI/AAAAAAAAN9Y/bzaHg8oxPwI46jKDtkSEtLCoL7gLaW0awCLcB/s1600/Schermata%2B2017-03-19%2Balle%2B23.19.49.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="400" src="https://1.bp.blogspot.com/-H5B3L1G0lJA/WM8ERyGwAdI/AAAAAAAAN9Y/bzaHg8oxPwI46jKDtkSEtLCoL7gLaW0awCLcB/s400/Schermata%2B2017-03-19%2Balle%2B23.19.49.png" width="205" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Command and Control Vulnerable Web Site</td></tr></tbody></table><b>Conclusions</b><br /><b><br /></b><div style="text-align: justify;">Despite the reverse engineering difficulty and/or the technical details I addressed in this quick and dirty post, I found an unusual C&amp;C behavior. Usually attackers want to protect their C&amp;C and are the first system (page, connection, services) to be closed and/or moved after a first disclosure. Indeed the attacker wont be "syncholed" by receiving injection commands into her malicious network. Contrary in this example the current C&amp;C looks to be alive from October 2016. Please note that I am not saying it servers RIG from 2016 but it might have served many different EK over time, which makes me thinking to a well defined operation attributable to a RIG as a service group.</div><br /><b>Useful IoC:</b><br />- url:&nbsp;<span style="color: blue;">see.aliharperweddings.com</span><br />- url:<span style="color: blue;">&nbsp;</span><span style="background-color: #f8f8f8; font-family: Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, monospace, serif; font-size: 12px;"><span style="color: blue;">far.nycfatfreeze.com</span></span><br />- ip: 193.70.90.120<br />- ip: 188.225.38.186<br />- email: rev00@india.com<br />- email: revenge00@writeme.com<br />- email: rev_reserv@india.com<br />- string:&nbsp;5427136ABEE9451E<br />- string: # !!!HELP_FILE!!! #.TXT<br />- string:&nbsp;<span style="font-size: 12.8px; text-align: center;">gexywoaxor&nbsp;</span><br />- file extension: REVENGE<br />- File Name: 8 characters from {<span style="text-align: justify;">abcdehiklmnoprstuw02346</span>}.exe<br /><br /><b>BONUS</b>:<br />A similar dropper (Third Stage) has been published on March 9th 2017 on <a href="http://pastebin.com/4E1WhLfy" target="_blank">pastebin</a>.<br /><br /></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=A%20quick%20REVENGE%20Analysis-http%3a%2f%2fmarcoramilli.com%2fpost%2fa-quick-revenge-analysis%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-quick-revenge-analysis%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-quick-revenge-analysis%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-quick-revenge-analysis%2f&title=A%20quick%20REVENGE%20Analysis" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-quick-revenge-analysis%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fa-quick-revenge-analysis%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
