<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Nozzle and BuBBLE: a trick to JUMP them! &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Mar 17, 2013</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          â€¢ 1000 words 5 min. read
        </div>
        <h1>Nozzle and BuBBLE: a trick to JUMP them!</h1>
        <section id="post-content" class="article-content post">
          <div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">It is a busy time for me and as you see I rarely find time to write on my own blog, but as promised in the past I'll keep on posting some of my notes. Today, for example, I want to stare a nice trick to bypass <a href="http://research.microsoft.com/pubs/76528/tr-2008-176.pdf">Noozle</a> and (theoretically) <a href="http://www.fort-knox.org/files/bubble.pdf">Bubble</a>; two of the most used anti heap spray techniques. Both of the techniques aim to block the "Heap Spray payload delivering". While Noozle recognizes a sprayed payload and block it, Bubble blocks the execution of the payload by messying up the memory.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Lets start to keep a quick and dirty look into the "Heap Spray Payload Delivery Technique". The following image shows how the payload is delivered through the "spray" technique.</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-qBSON9FDqck/UUX_jLvr4HI/AAAAAAAALPQ/FJSxz_6_lQw/s1600/Screen+Shot+2013-03-17+at+6.37.01+PM.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="197" src="http://1.bp.blogspot.com/-qBSON9FDqck/UUX_jLvr4HI/AAAAAAAALPQ/FJSxz_6_lQw/s400/Screen+Shot+2013-03-17+at+6.37.01+PM.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Payload Delivering technique: Heap Spray (From Microsot Noozle paper)</td><td class="tr-caption" style="text-align: center;"><br /></td><td class="tr-caption" style="text-align: center;"><br /></td></tr></tbody></table><div style="text-align: justify;">The attacker delivers to the target machine a significant number of payloads composed by a NOP sequence (white in the picture) and a final Shellcode (red in the picture). In order to guarantee high performances the kernel allocates memory randomly (ASLR) BUT in organized and atomic blocks.&nbsp; Dependining on the memory blocks size it happens to have contiguous payloads.&nbsp; Once the payloads have loaded into the memory the attacker needs to "fire" one of them by pointing EIP to the top-level addressese (NOP) which will eventually take the CPU to execute the desired Shellcode.&nbsp;</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">A full attack scenario follows three main steps:</div><ol style="text-align: justify;"><li>Spray the Heap. Dinamic memory allocation. Fiilling memory with NOP+Shellcode</li><li>Trigger the bug. Firing UP the bug to get a pointer.</li><li>Control \xEIP to point to the Heap. Making the pointer "pointing" to the memory heap.</li></ol><div style="text-align: justify;">One of the most classic way to Spray the heap is to use scripting laguage such as: javascript for spraying browsers or&nbsp; PDF readers, VBA macros for spraying Microsoft Office suite, ActionsScriptins for spraying Adobe Flash, etc...&nbsp; One of the most famous (IE6/IE7) script used by attacker all around the world is the following one (I don't know who the author is)</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-qX49t0DchE8/UUYFK4FB49I/AAAAAAAALPY/aD_2QTiG6xs/s1600/Screen+Shot+2013-03-17+at+7.00.56+PM.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="125" src="http://4.bp.blogspot.com/-qX49t0DchE8/UUYFK4FB49I/AAAAAAAALPY/aD_2QTiG6xs/s400/Screen+Shot+2013-03-17+at+7.00.56+PM.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Spray Heap commonly used scripts, from spray2.html (exploitdb)</td></tr></tbody></table><br /><div style="text-align: justify;">The anonymous script will produce a heap layout like the one showed in the next picture where&nbsp; the big yellow section (in the bottom of the memory graphic visualization)&nbsp; represents the contiguous payload (NOP+Shellcode) just allocated in the memory&nbsp; (memory array variable in the script):</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-g0cyjW0ELfM/UUYKm2ZlykI/AAAAAAAALPw/FJnzpI7Zsu4/s1600/Screen+Shot+2013-03-17+at+7.24.30+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="188" src="http://2.bp.blogspot.com/-g0cyjW0ELfM/UUYKm2ZlykI/AAAAAAAALPw/FJnzpI7Zsu4/s320/Screen+Shot+2013-03-17+at+7.24.30+PM.png" width="320" /></a></div><br />&nbsp; <br /><div style="text-align: justify;">An example of how to trigger the payload generated by the anonymous script, using SEH chain&nbsp; could be the following:</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-kh6H9Obqmk8/UUYIHLahi0I/AAAAAAAALPo/lAoi9C24leM/s1600/Diapositiva1.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="300" src="http://3.bp.blogspot.com/-kh6H9Obqmk8/UUYIHLahi0I/AAAAAAAALPo/lAoi9C24leM/s400/Diapositiva1.jpg" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Example of Payload using SEH chain technique. Add NOPs in the first JUNK section to have more chances to get it.</td><td class="tr-caption" style="text-align: center;"><br /></td></tr></tbody></table><div class="separator" style="clear: both; text-align: center;"></div><br /><div style="text-align: justify;">&nbsp;A wrong access to the RET address&nbsp; (\xff\xff\xff\xff) raises the SEHandler which points directly to the memory heap (which is randomized but always on top of the stack ... top = lower addresses...) where is located the payload. From the attacker prespective it is enough to find out a NOP in the memory heap. The NOP sleed will take the CPU to execute the desired payload.</div><div>&nbsp;</div><div>According to the paper: "Noozle: A Defense Against Heap-spraying Code Injection Attacks" by Paruj Ratanaworabhan et Al. it possible to exploits the pattern used by memory heap sprayers against themeselves. Common "sprayers" (like the script above) allocte high memory content, one close to the other, filled by NOPs and Sellcodes.</div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-LBaOrOuxIYU/UUYMCK7dJCI/AAAAAAAALP4/MzpQtm5yb78/s1600/Screen+Shot+2013-03-17+at+7.21.58+PM.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="208" src="http://3.bp.blogspot.com/-LBaOrOuxIYU/UUYMCK7dJCI/AAAAAAAALP4/MzpQtm5yb78/s400/Screen+Shot+2013-03-17+at+7.21.58+PM.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Noozle system architecture, From Noozle paper by Microsoft</td></tr></tbody></table><div style="text-align: justify;">The previous image represents the Nozzle architecture. Noozle parses and detects memory alloctions before letting them free in the Browser heap. This security layer introduced in IE8 does not reduce the overall process speed and it's totally transparent to the user. If the Noozle's detectors find a payload according to the described pattern, the running script execution is blocked. Contrary if not patterns have detected the content is freely available to the application heap.</div><div>&nbsp;</div><div style="text-align: justify;">Another gret example of how to prevent&nbsp; memory heap spraying implemented on Mozilla Firefox is called BuBBLE. Introduced by Francesco Gadelata et Al in 2010 it changes the way javascript writes strings in the memory. The following image shows what a delivered payloads becomes after BuBBLE messed up with it</div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-YGYxpHgliAE/UUYPiu0K_DI/AAAAAAAALQA/Z66LdrQ75eg/s1600/Screen+Shot+2013-03-17+at+7.44.58+PM.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="155" src="http://1.bp.blogspot.com/-YGYxpHgliAE/UUYPiu0K_DI/AAAAAAAALQA/Z66LdrQ75eg/s400/Screen+Shot+2013-03-17+at+7.44.58+PM.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">BuBBLE memory transformation (From <a href="http://dl.acm.org/citation.cfm?id=2175007">Bubble</a> Paper, ACM)</td></tr></tbody></table><div><br /></div><div>&nbsp;</div><div>&nbsp;</div><div style="text-align: justify;">Aim of this contromeasure is to change the way javascript strings are dinamically allocated in the memory. As the image shows it gets hard from the attacker to address the exact point in the heap since NOP chain is interrupted by BuBBLE.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Both of these techniques are very effective in modern browsers, but what if do we introduce smaller payloads within further jump instructions? In other words; what if do we add a "jump to a further small payload" in addition to the NOPs chain ?</div><div>&nbsp;</div><div style="text-align: justify;">The following image shows an example of this trick. The delivered payload -- which uses a ROP chain to bypass DEP/Nx protection-- bypasses Nozzle detectors since the NOPs chain is reduced and jump statements have used. I decided to introduce ROP chain in this example just to let you know the techniques are componible and can be used toghether. For more information about ROP <a href="http://marcoramilli.blogspot.it/search?q=ROP&amp;x=0&amp;y=0">here</a>.</div><div>&nbsp;</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-ubGCn5CaIJw/UUYTw1T5d2I/AAAAAAAALQI/RmDlIOKAzBM/s1600/Diapositiva2.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="300" src="http://1.bp.blogspot.com/-ubGCn5CaIJw/UUYTw1T5d2I/AAAAAAAALQI/RmDlIOKAzBM/s400/Diapositiva2.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Example of possible delivered payload to bypass Noozle</td></tr></tbody></table><div>&nbsp; </div><div>&nbsp;</div><div style="text-align: justify;">&nbsp;This technique is about reducing the payload size and the number of NOPs in memory. Splitting the payload into multiple smaller payloads chained together through a forward JUMP. Statistically speaking the most probable address in which to JUMP is on \0x0c0c0c0c. Why this is the most "probable" address is not scope of this post. I might have time to describe the most probable addresses (\0x06060606, \0x08080808, \0x09090909) in future posts.</div><div>&nbsp;</div><div style="text-align: justify;">In this post another great example on how "security" follows "hacking" and on how security following hacking failed and will fail again. I do believe that Security should prevent hacking and not following it; more research on how to prevent Heap Spraying Technique is needed. &nbsp; </div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div><br /></div></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Nozzle%20and%20BuBBLE%3a%20a%20trick%20to%20JUMP%20them%21-http%3a%2f%2fmarcoramilli.com%2fpost%2fnozzle-and-bubble-a-trick-to-jump-them%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fnozzle-and-bubble-a-trick-to-jump-them%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fnozzle-and-bubble-a-trick-to-jump-them%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fnozzle-and-bubble-a-trick-to-jump-them%2f&title=Nozzle%20and%20BuBBLE%3a%20a%20trick%20to%20JUMP%20them%21" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fnozzle-and-bubble-a-trick-to-jump-them%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fnozzle-and-bubble-a-trick-to-jump-them%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
