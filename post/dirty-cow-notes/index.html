<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Dirty COW Notes &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Oct 30, 2016</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          • 1000 words 5 min. read
        </div>
        <h1>Dirty COW Notes</h1>
        <section id="post-content" class="article-content post">
          <div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">I am not used to write about vulnerabilities because there are too much vulnerabilities out here and writing about just one of them is not going to contribute security community at all. So why am I writing about Diry Cow ? I am going to write about it because, in my personal opinion, it is huge. When I say "huge" I don't really mean it will be used to exploit the "entire world" but I mean it highlights two mains issues:</div><ul style="text-align: left;"><li style="text-align: justify;">Even patched code could easily hide the same vulnerability, just in a different way. How many patched code are not really "patched" ?</li><li style="text-align: justify;">A new pragmatic approach to identify vulnerabilities: looking into patched code and check the &nbsp;patch implementation.</li></ul><div><div style="text-align: justify;">But let's start from the beginning by taking a closer look to the exploit code.</div></div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-deIqh3KInyI/WBTE1Y7841I/AAAAAAAANbo/qaxDhLJ9HW0BwGkp5HIzHH4GzxvdJMfuwCLcB/s1600/Screen%2BShot%2B2016-10-29%2Bat%2B17.47.35.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="640" src="https://3.bp.blogspot.com/-deIqh3KInyI/WBTE1Y7841I/AAAAAAAANbo/qaxDhLJ9HW0BwGkp5HIzHH4GzxvdJMfuwCLcB/s640/Screen%2BShot%2B2016-10-29%2Bat%2B17.47.35.png" width="376" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Click to enlarge: Taken From <a href="https://www.exploit-db.com/exploits/40611/?rss">Here</a></td></tr></tbody></table><br /><div>As many other kernel vulnerabilities it relays on concurrency; the exploit code fires on two separate threads who will access at the same time to the same resource. &nbsp;Taking a closer look to the main function you will see that the <a href="http://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a> syscall has been used.</div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://3.bp.blogspot.com/-hXNSwoh-XT4/WBTF1tl3BZI/AAAAAAAANbw/NP5vFh74K1c3LyjgIAD9oWfBIWkTyTA_ACLcB/s1600/Screen%2BShot%2B2016-10-29%2Bat%2B17.52.31.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="15" src="https://3.bp.blogspot.com/-hXNSwoh-XT4/WBTF1tl3BZI/AAAAAAAANbw/NP5vFh74K1c3LyjgIAD9oWfBIWkTyTA_ACLcB/s400/Screen%2BShot%2B2016-10-29%2Bat%2B17.52.31.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">calling mmap function</td></tr></tbody></table><div>From documentation:</div><div><blockquote class="tr_bq"><i>creates a new mapping in the virtual address space of the        calling process.  The starting address for the new mapping is        specified in addr.  The length argument specifies the length of the        mapping.  </i></blockquote></div><div><br /></div><div><div style="text-align: justify;">mmap does not create a memory copy but rather it creates a new mapping of that (filedescriptor) memory area. It means the process will read data directly from the original file rather than from a copy of it. &nbsp;While most of the parameters are obvious the MAP_PRIVATE flag is the "core" of the vulnerability. It enables the "copy on write" (from here the name COW) which basically copies the original data in a new memory area during the write access to the same data. Since the mmap has just mapped a readonly area and the process wants to write data on it, mmap (MAP_PRIVATE) will create a copy of that data on write actions, the modified data will not be propagated to the original memory area.&nbsp;</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Now the exploit runs two threads which will exploit a race condition to get "write access" to the original memory area. The first thread runs several times the function call madvise (memory advise) which is used to increase process performances by tagging a memory area according to its usage: for example &nbsp;the memory could be tagged as NORMAL, &nbsp;SEQUENTIAL, FREE or WILLNEED, an so on... In the exploit, the mmap memory is continuously tagged as DONTNEED, &nbsp;which basically means the memory is not going to be used in the next future so the kernel could free its space<b> and reload the content only when needed.</b></div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://4.bp.blogspot.com/-vvMCqgQMYCQ/WBTKi4ZGwSI/AAAAAAAANb8/gWdj42bc_l8w_OtknUc5NtWswOFQ_wiwwCLcB/s1600/Screen%2BShot%2B2016-10-29%2Bat%2B18.12.31.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="211" src="https://4.bp.blogspot.com/-vvMCqgQMYCQ/WBTKi4ZGwSI/AAAAAAAANb8/gWdj42bc_l8w_OtknUc5NtWswOFQ_wiwwCLcB/s400/Screen%2BShot%2B2016-10-29%2Bat%2B18.12.31.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">First Thread implementing madvise</td></tr></tbody></table><br /><div style="text-align: justify;">On the other hand another thread is writing on its own memory space (by abusing the pseudo file notation: /proc/self/mem) directly on the mmap area pointing to the opened file. Since we have invoked the mmap function through the MAP_PRIVATE flag we are not going to write on the specifi memory but on a copy of it (copy on write).</div><br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://4.bp.blogspot.com/-rkbL92c6zBU/WBTL2yzxaII/AAAAAAAANcA/8kXEINmIszM4dhLxHjOZsdkpFwRHHdrBQCLcB/s1600/Screen%2BShot%2B2016-10-29%2Bat%2B18.17.23.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="175" src="https://4.bp.blogspot.com/-rkbL92c6zBU/WBTL2yzxaII/AAAAAAAANcA/8kXEINmIszM4dhLxHjOZsdkpFwRHHdrBQCLcB/s400/Screen%2BShot%2B2016-10-29%2Bat%2B18.17.23.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Second Thread implementing write on pseudo self/mem</td></tr></tbody></table><div style="text-align: justify;"><br /></div><div style="text-align: justify;">The race condition between those two threads tricks the write on copy on the original memory area since the copied area could be tagged has DONTNEED while the write procedure is not finished yet. And voilà you are going to write in a readonly file !</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">OK now we figured out how the trick worked so far but what is most interesting is the story behind it?</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Going on <a href="https://lkml.org/lkml/2016/10/19/860">issue tracker:</a> Linus Trovalds (maximum respect) wrote:</div><div style="text-align: justify;"><br /></div><blockquote class="tr_bq" style="text-align: justify;">This is an ancient bug that was actually attempted to be fixed once (badly) by me eleven years ago in commit 4ceb5db9757a ("Fix get_user_pages() race for write access") but that was then undone due to problems on s390 by commit f33ea7f404e5 ("fix get_user_pages bug").  In the meantime, the s390 situation has long been fixed, and we can now fix it by checking the pte_dirty() bit properly (and do it better).  The s390 dirty bit was implemented in abf09bed3cce ("s390/mm: implement software dirty bits") which made it into v3.9.  Earlier kernels will have to look at the page state itself.  Also, the VM has become more scalable, and what used a purely theoretical race back then has become easier to trigger.</blockquote><div style="text-align: justify;">S390 is ancient IBM technology.... I am not even sure it still exists on real world (at least if compared to recent systems). Probably linux community forgot about that removal otherwise would left it in the recent memory managers.<br /><br /></div><div style="text-align: justify;">Anyhow the bug now "has been fixed" by introducing a new internal Flag called FOLL_COW (really !?J) which basically says "yes I already did the copy on write".<br />Basically the process can write to even unwritable pte's, but only after it has gone through a COW cycle and they are dirty. Following the diff patch<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-Tl_WbTpGwvo/WBTTGVtIzjI/AAAAAAAANcU/-iS6SeZ2HNQUv06yMyDJaZOStbQzhY61QCLcB/s1600/Screen%2BShot%2B2016-10-29%2Bat%2B18.48.56.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="400" src="https://1.bp.blogspot.com/-Tl_WbTpGwvo/WBTTGVtIzjI/AAAAAAAANcU/-iS6SeZ2HNQUv06yMyDJaZOStbQzhY61QCLcB/s400/Screen%2BShot%2B2016-10-29%2Bat%2B18.48.56.png" width="367" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Dirty Cow Patch3 on October 2016</td></tr></tbody></table><br /></div><br /><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Dirty Cow vulnerability blowed in my mind a new vulnerability hunting process. On one hand laboratories with extremely sophisticated, tuned and personalised fuzzers perform the "industrial" way (corporate and/or governative) to find new vulnerabilities, on the other hand more romantic and crafty way done by professionals and/or security researchers used to adopt handy works and smart choices. But another smart approach (industrial or romantic) could be to investigate into the patched code by itself.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Patched code is by definition where a bug or issue where located. The most difficult part of finding vulnerabilities (not exploiting them) is to figure out where they are in thousands lines of code. So finding vulnerability on patched code could be much more quick even if with high "hypothetical" complexity since a patch is involved. But as this case testifies ... &nbsp;is not always the case!</div></div></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Dirty%20COW%20Notes-http%3a%2f%2fmarcoramilli.com%2fpost%2fdirty-cow-notes%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fdirty-cow-notes%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fdirty-cow-notes%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fdirty-cow-notes%2f&title=Dirty%20COW%20Notes" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fdirty-cow-notes%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fdirty-cow-notes%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
