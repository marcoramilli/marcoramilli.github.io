<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Angler and the new threats &middot; Marco Ramilli </title>
    
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://marcoramilli.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://marcoramilli.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Marco Ramilli" />
    
    <script src="http://marcoramilli.com/js/jquery.min.js"></script>
    <script src="http://marcoramilli.com/js/main.min.js">
    </script>
</head>

<body>
  <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                  <hr class="panel-cover__divider panel-cover__divider--secondary" />


                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fa fa-code-fork'></i></a>  
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                        </nav> 
                    </div>
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>


            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://marcoramilli.com/" title="link to homepage for Marco Ramilli"> <img src="http://marcoramilli.com/images/MR.jpg" width="80" alt="Marco Ramilli logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://marcoramilli.com/"  title="link to homepage for Marco Ramilli">Marco Ramilli</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  cat /dev/random | grep cybersecurity  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                              <li class="navigation__item"><a href="http://marcoramilli.com/#blog" title="link to Marco Ramilli blog"> <i  class='fa fa-th'></i></a> </li></br>
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/about" title="About "> <i  class='fa fa-user'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/projects" title="Some of my Projects"> <i  class='fafa-code-fork'></i></a> </li></br> 
                                  <li class="navigation__item"><a href="http://marcoramilli.com/pages/publications" title="Selected Publications"> <i class='fa fa-book'> </i></a>  
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/Marco_Ramilli" title="@Marco_Ramilli on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/marcoramilli" title="marcoramilli on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>  
        
        <li class="navigation__item">
            <a href="https://www.linkedin.com/in/marcoramilli" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
        </li>  
        
        <li class="navigation__item">
            <a href="mailto:mramilli@gmail.com" title="Email mramilli@gmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

  <div class="content-wrapper">
    <div class="content-wrapper__inner">
      <div class="post">
        <div class="post-meta">
          <span class="post-meta__date date">Mar 6, 2015</span>
          
          <span class="post-meta__tags tags">
            <font class="tags">
              
            </font>
          </span>
          • 700 words 3 min. read
        </div>
        <h1>Angler and the new threats</h1>
        <section id="post-content" class="article-content post">
          <div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">What I am writing is not a "news" anymore, but it is like a "consciousness raising" about the incredible job the guys behind <b>Angler</b> Exploit kit did.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">But, let me start from the beginning. For everybody out there do not know what an Exploit Kit is I found out a clear and nice description from McAfee Labs:</div><div style="text-align: justify;"><blockquote class="tr_bq">An exploit kit is an off-the-shelf software package containing easy-to-use packaged attacks on known and unknown (zero-day) vulnerabilities. These toolkits exploit client-side vulnerabilities, typically targeting the web browser and applications that can be accessed by the web browser. Exploit kits can also track infection metrics and have robust control capabilities </blockquote></div><div style="text-align: justify;">Angler is one of several Exploit Kits available for attackers. Actually  Angler Exploit Kit has become the most advanced, much more powerful and the best exploit kit available in the market so far, beating the infamous BlackHole exploit kit, with a host of exploits including zero-days and new techniques added to it.&nbsp;</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">What makes Angler so great are the following two characteristics: <b>Domain Shadowing</b> (”DSH“) and <b>Filess</b> <b>Infection</b> "Filess".</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">One of the newest techniques bheind Angnler Exploit Kit is the so called “<b>Domain</b> <b>Shadowing</b>”. Domain Shadowing, first appeared in 2011, is the process of using "users domain registration logins" to create subdomains used to spread the malware content. <a href="http://blogs.cisco.com/author/NickBiasini" target="_blank">Nik Biasini </a>from the Cisco Talos Group did a great job in <a href="http://blogs.cisco.com/security/talos/angler-domain-shadowing#fastfluxcomp" target="_blank">describing</a> the differences between the classic <b>Fast Flux </b>DNS Techniques and the <b>Domain Shadowing </b>technique implemented in Angler Exploit Kit. The following image (taken from Talos Description) shows the difference between the most common Fast Flux Versus the recent Domain Shadowing.</div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-Z_U8GYf4K-E/VPlc7M-X4AI/AAAAAAAAMOg/2uHsEtgqNVU/s1600/Screen%2BShot%2B2015-03-06%2Bat%2B08.52.36.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="198" src="http://3.bp.blogspot.com/-Z_U8GYf4K-E/VPlc7M-X4AI/AAAAAAAAMOg/2uHsEtgqNVU/s1600/Screen%2BShot%2B2015-03-06%2Bat%2B08.52.36.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fast Flux VS Domain Shadogin (from <a href="http://blogs.cisco.com/security/talos/angler-domain-shadowing#fastfluxcomp" target="_blank">Talos Description</a>)</td></tr></tbody></table><br /><div style="text-align: justify;">While fast flux is continuously changing the DNS record value (well there are plenty variants of it, so please forgive my generalization) in order to confuse analysis, domain shadowing makes use af many real dns stolen account to make them redirect to malicious content. This techniques is "a way more complex" to be realized since the bot maker needs to compromise DNS records and/or DNS credentials.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><b>Filess</b> <b>Infection</b> is another great new feature introduced into the Angler ExploitKit. The obvious difference between Filess injection and File injection is in the way the Exploitkit drops and loads the new payloads. The following image clearly shows the difference between the two techniques. On the left side a file injection in which the Exploit kit saves the malicious .ddl into a temp directory and later on it loads the malicious .dll from the disk <u>(This approach preserves easy persistance but it mostly subjected to AV discovery).</u></div><div style="text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-84WKj6QXCmA/VPliUXd0mXI/AAAAAAAAMOw/eH922lGcS6c/s1600/Screen%2BShot%2B2015-03-06%2Bat%2B09.13.17.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="142" src="http://1.bp.blogspot.com/-84WKj6QXCmA/VPliUXd0mXI/AAAAAAAAMOw/eH922lGcS6c/s1600/Screen%2BShot%2B2015-03-06%2Bat%2B09.13.17.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">File injection VS Filess injection</td></tr></tbody></table><div style="text-align: justify;">On the right side of the image the process directly loads into memory the downloaded stream running it through a new thread. This method makes it harder the persistence and makes it easier the network detection but it makes almost impossible the host detection by AV engines.&nbsp; The following screenshot shows a piece of code that makes this happen by (I did follow the steps in <a href="http://securityxploded.com/memory-execution-of-executable.php" target="_blank">here</a>):<br /><br /><ol><li>&nbsp;Read first page of the file which includes DOS header, PE header, section headers etc.&nbsp;</li><li>Fetch Image Base address from PE header and determine if that address is available else allocate another area.  (Case of relocation)&nbsp;</li><li>Map the sections into the allocated area&nbsp;</li><li>Read information from import table and load the DLLs&nbsp;</li><li>Resolve the function addresses and create Import Address Table (IAT).&nbsp;</li><li>Create initial heap and stack using values from PE header.</li><li>Create main thread and start the process. </li></ol></div><div style="text-align: justify;"><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-fjxJIRPLOVo/VPllmrbZrBI/AAAAAAAAMO8/JYrB_6_rqdY/s1600/Screen%2BShot%2B2015-03-06%2Bat%2B09.27.01.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="260" src="http://4.bp.blogspot.com/-fjxJIRPLOVo/VPllmrbZrBI/AAAAAAAAMO8/JYrB_6_rqdY/s1600/Screen%2BShot%2B2015-03-06%2Bat%2B09.27.01.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Filess Execution Example. Code goes from left to right (it's the sam file)</td></tr></tbody></table><br /></div><div style="text-align: justify;">Nowadays we are even experiences <b>Powelinks</b> (CVE-2012-0158, which makes storing payloads into registry) and <b>Filess</b> Combo, which makes Angler even more undetectable.<br /><br />Following a McAfee graph showing the variance of several Exploit kits during 2014. <b>Angler</b> got 14 variances in few months,&nbsp; Amusing !<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-kC_aVOKd9Xc/VPm5dc41WbI/AAAAAAAAMPM/CEOFPYrWP1k/s1600/Screen%2BShot%2B2015-03-06%2Bat%2B15.26.25.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="258" src="http://2.bp.blogspot.com/-kC_aVOKd9Xc/VPm5dc41WbI/AAAAAAAAMPM/CEOFPYrWP1k/s1600/Screen%2BShot%2B2015-03-06%2Bat%2B15.26.25.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Exploit Kits in 2014 (<a href="http://www.mcafee.com/ca/resources/solution-briefs/sb-quarterly-threat-q4-2014-2.pdf" target="_blank">McAfee</a>)</td><td class="tr-caption" style="text-align: center;"><br /></td><td class="tr-caption" style="text-align: center;"><br /></td></tr></tbody></table><br /></div></div>

        </section>
      </div>
      <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Angler%20and%20the%20new%20threats-http%3a%2f%2fmarcoramilli.com%2fpost%2fangler-and-the-new-threats%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fmarcoramilli.com%2fpost%2fangler-and-the-new-threats%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fangler-and-the-new-threats%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fmarcoramilli.com%2fpost%2fangler-and-the-new-threats%2f&title=Angler%20and%20the%20new%20threats" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fangler-and-the-new-threats%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fmarcoramilli.com%2fpost%2fangler-and-the-new-threats%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>

      



      <footer class="footer"></footer>

    </div>
  </div>
</body>
<script type="text/javascript" src="http://marcoramilli.com/js/awesome-toc.min.js"></script>
<script type="text/javascript">
$.awesome_toc({        
      title: "Index",
          overlay: true,
              contentId: "post-content",
});
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5633272-11', 'auto');
  ga('send', 'pageview');
</script>


</html>
